input {
  tcp {
    port => 9201
    codec => json_lines
    type => "winston"
  }
}

filter {
  # Parse JSON logs from Winston
  if [type] == "winston" {
    # Winston already uses @timestamp, but handle both formats for compatibility
    if [time] {
      date {
        match => [ "time", "ISO8601" ]
        target => "@timestamp"
      }
    }
    
    # Ensure @timestamp exists (Winston provides it, but handle edge cases)
    if ![@timestamp] and [time] {
      mutate {
        rename => { "time" => "@timestamp" }
      }
    }
    
    # Winston uses timestamp field, convert if needed
    if ![@timestamp] and [timestamp] {
      date {
        match => [ "timestamp", "ISO8601" ]
        target => "@timestamp"
      }
    }
    
    # Normalize log level
    if [level] {
      mutate {
        lowercase => [ "level" ]
      }
    }
    
    # Add environment tag
    if [env] {
      mutate {
        add_tag => [ "%{env}" ]
      }
    }
    
    # Add service tag
    if [service] {
      mutate {
        add_tag => [ "service:%{service}" ]
      }
    }
    
    # Parse error stack traces if present
    if [stack] {
      mutate {
        add_tag => [ "has_stack_trace" ]
      }
    }
    
    # Extract HTTP method and route for better filtering
    if [method] {
      mutate {
        add_field => { "[http][method]" => "%{method}" }
      }
    }
    
    if [route] {
      mutate {
        add_field => { "[http][route]" => "%{route}" }
      }
    }
    
    if [url] {
      mutate {
        add_field => { "[http][url]" => "%{url}" }
      }
    }
    
    # Extract error code if present
    if [code] {
      mutate {
        add_field => { "[error][code]" => "%{code}" }
      }
    }
    
    # Extract event type
    if [event] {
      mutate {
        add_field => { "[event][type]" => "%{event}" }
      }
    }
    
    # Clean up sensitive data from headers if needed
    if [headers] {
      # Remove sensitive headers (you can customize this)
      if [headers][authorization] {
        mutate {
          update => { "[headers][authorization]" => "[REDACTED]" }
        }
      }
      if [headers][cookie] {
        mutate {
          update => { "[headers][cookie]" => "[REDACTED]" }
        }
      }
    }
    
    # Add hostname
    mutate {
      add_field => { "[log][source]" => "logstash" }
    }
    
    # Winston-specific: handle level field (Winston uses level as string)
    if [level] {
      mutate {
        lowercase => [ "level" ]
      }
    }
  }
}

output {
  # Output to stdout (useful for Docker logs)
#   stdout {
#     codec => rubydebug {
#       metadata => false
#     }
#   }
  
  # Uncomment and configure if you want to send to Elasticsearch
  elasticsearch {
    hosts => ["elasticsearch:9200"]
    index => "logs-%{+YYYY.MM.dd}"
  }
  
  # Uncomment if you want to send to a file
  # file {
  #   path => "/var/log/logstash/application-%{+YYYY-MM-dd}.log"
  #   codec => json_lines
  # }
}
